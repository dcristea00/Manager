<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>INVOBRA</title>
  <style>
    /* ========== Base (modo NOCHE por defecto) ========== */
    :root{
      --bg:#0e1b2b; --panel:#122b47; --panel-2:#11324a;
      --ink:#f3f7ff; --muted:#c9d6ee; --line:#2c5c80;
      --brand:#2a6f97; --brand-2:#014f86; --accent:#61a5c2;
      --danger:#ef4444; --radius:16px;
    }

    /* ========== Modo DÍA (agua cristalina) ========== */
    :root[data-theme="light"]{
      --bg:#f4fbff; --panel:#ffffff; --panel-2:#f0f7ff;
      --ink:#0f172a; --muted:#4b5563; --line:#cfe0f5;
      --brand:#3db5ff; --brand-2:#1e9be6; --accent:#9be2ff;
      --danger:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14.5px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--ink);background:linear-gradient(180deg,var(--bg),#0a1230)}
    .hidden{display:none!important}
    .i{width:22px;height:22px;fill:currentColor;stroke:currentColor}

    .app-header{position:sticky;top:0;z-index:10;padding:8px 10px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(18,43,71,.9),rgba(18,43,71,.7));backdrop-filter:blur(10px)}
    :root[data-theme="light"] .app-header{background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.85))}
    .header-row{display:flex;align-items:center;justify-content:space-between}
    .app-title{font-weight:800;letter-spacing:.22rem;font-size:18px}
    .toolbar{display:grid;gap:8px;margin-top:8px}
    .row{display:flex;align-items:center;gap:8px}
    .row.wrap{flex-wrap:wrap}
    .row.between{justify-content:space-between}
    .stack{display:grid;gap:8px}
    .w-full{width:100%}
    .alert-region{min-height:22px;margin:6px 0}

    /* Ocultar toolbar cuando el router lo indique */
    body.hide-toolbar #obra-toolbar{display:none}

    .app-main{display:grid;gap:10px;padding:10px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:10px}
    .card.compact{padding:10px}
    .separator{height:1px;background:#2b4f70;margin:8px -2px}
    :root[data-theme="light"] .separator{background:#dbeafe}

    label{display:flex;flex-direction:column;gap:6px;position:relative}
    input,select,textarea{width:100%;min-height:40px;border-radius:12px;border:1px solid var(--line);background:#ffffff;color:#0e1325;padding:8px 10px}
    :root[data-theme="light"] input,:root[data-theme="light"] select,:root[data-theme="light"] textarea{border-color:#cfe0f5;background:#fff}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,currentColor 50%),linear-gradient(135deg,currentColor 50%,transparent 50%);background-position:calc(100% - 20px) 50%,calc(100% - 14px) 50%;background-size:5px 5px,5px 5px;background-repeat:no-repeat}
    input::placeholder,textarea::placeholder{color:#7b8fb4}

    /* Autocompletado */
    .suggestions-dropdown{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:8px;
      max-height:200px;
      overflow-y:auto;
      z-index:100;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    .suggestion-item{
      padding:8px 12px;
      cursor:pointer;
      border-bottom:1px solid var(--line);
    }
    .suggestion-item:hover{
      background:var(--panel-2);
    }
    .suggestion-item:last-child{
      border-bottom:none;
    }
    .suggestion-meta{
      color:var(--muted);
      font-size:0.9em;
    }

    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;min-height:38px;border-radius:12px;border:1px solid #334175;background:#0f1b3e;color:#fff;cursor:pointer}
    .btn:hover{filter:brightness(1.02)}
    .btn.primary{background:linear-gradient(180deg,var(--accent),var(--brand));border-color:transparent;color:#001}
    :root[data-theme="light"] .btn{background:#eef6ff;color:#0b2c4d;border-color:#cfe0f5}
    :root[data-theme="light"] .btn.primary{background:linear-gradient(180deg,#c9eeff,#64c8ff)}
    .btn.danger{background:linear-gradient(180deg,#ff6b6b,var(--danger));border-color:transparent;color:#fff}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--ink)}
    .btn.square{width:44px;height:44px;justify-content:center}

    .chips{display:flex;gap:6px}
    .chip{background:#0f1b3e;border:1px solid #334175;padding:4px 8px;border-radius:999px}
    :root[data-theme="light"] .chip{background:#eef6ff;border-color:#cfe0f5;color:#0b2c4d}

    /* Grid obras (inicio) */
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .card-obra{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;cursor:pointer;position:relative}
    .card-obra img{width:100%;height:110px;object-fit:cover;display:block}
    .card-obra .meta{padding:8px;font-weight:600}
    .card-obra .change{position:absolute;top:8px;right:8px}

    /* Tabla / Cards móvil */
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid var(--line);background:var(--panel-2)}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;white-space:normal;word-break:normal;overflow-wrap:anywhere;line-height:1.3}
    thead th{position:sticky;top:0;background:#0c1738;color:#fff;z-index:1}
    :root[data-theme="light"] thead th{background:#e6f2ff;color:#0b2c4d}
    .empty{text-align:center;padding:18px}

    /* Nombres de ítems en categorías */
    .item-names{
      background:var(--panel-2);
      padding:8px;
      border-radius:8px;
      margin-top:8px;
      font-size:0.9em;
      line-height:1.4;
    }

    @media (max-width:520px){
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{border:1px solid var(--line);border-radius:12px;background:var(--panel);padding:10px;margin-bottom:10px}
      td{display:grid;grid-template-columns:110px 1fr;gap:6px;padding:6px 0;border:0}
      td:nth-child(1)::before{content:'Nombre';font-weight:600}
      td:nth-child(2)::before{content:'Categoría';font-weight:600}
      td:nth-child(3)::before{content:'Subtipo';font-weight:600}
      td:nth-child(4)::before{content:'Cantidad';font-weight:600}
      td:nth-child(5)::before{content:'Marca';font-weight:600}
      td:nth-child(6)::before{content:'Ubicación';font-weight:600}
      td:nth-child(7)::before{content:'Observaciones';font-weight:600}
      td:nth-child(8)::before{content:'Acciones';font-weight:600}
    }

    /* Modal */
    dialog{border:0;padding:0;background:transparent}
    dialog[open]{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dialog-card{background:#fff;color:#0f172a;border:1px solid #dfe7f2;border-radius:18px;width:min(520px,92vw);max-height:85vh;display:grid;grid-template-rows:auto 1fr auto;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.45)}
    .dialog-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e6eef8;background:#f7faff}
    .dialog-head h3{margin:0;font-size:18px;color:#0b2c4d}
    .dialog-body{padding:12px 14px;overflow:auto;background:#fff}
    .dialog-foot{display:flex;align-items:center;gap:8px;padding:12px 14px;border-top:1px solid #e6eef8;background:#f7faff}
    .spacer{flex:1}

    /* Tabs - Sin pestaña Precios */
    .tabbar{position:sticky;bottom:0;z-index:10;border-top:1px solid var(--line);background:linear-gradient(180deg,rgba(18,43,71,.6),rgba(18,43,71,.9));backdrop-filter:blur(10px);display:grid;grid-template-columns:repeat(5,1fr)}
    :root[data-theme="light"] .tabbar{background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.95))}
    .tab{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 6px;color:#c6d4ee;text-decoration:none}
    .tab.active{color:#fff}
    :root[data-theme="light"] .tab{color:#415a77}
    :root[data-theme="light"] .tab.active{color:#0b2c4d}

    /* Títulos de vista */
    .view-title{margin:4px 6px 10px}
    .view{padding:0}

    /* Formulario en grid */
    .grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .grid .full{grid-column:1/-1}

    /* Muted text */
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <!-- ICON SPRITES -->
  <svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden"><defs>
    <symbol id="i-home" viewBox="0 0 24 24"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-10.5Z"/></symbol>
    <symbol id="i-list" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
    <symbol id="i-cats" viewBox="0 0 24 24"><path d="M5 6h14v3H5zM5 11h14v3H5zM5 16h14v3H5z"/></symbol>
    <symbol id="i-info" viewBox="0 0 24 24"><path d="M12 8.5a1.2 1.2 0 1 0 0-2.4 1.2 1.2 0 0 0 0 2.4ZM11 11h2v7h-2z"/><circle cx="12" cy="12" r="10" fill="none" stroke-width="1.5"/></symbol>
    <symbol id="i-download" viewBox="0 0 24 24"><path d="M12 8v9m0 0 4-4m-4 4-4-4M5 20h14" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
    <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
    <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Z"/><path d="M14.06 6.19 16.88 3.37 20.63 7.12 17.81 9.94z"/></symbol>
    <symbol id="i-trash" viewBox="0 0 24 24"><path d="M5 7h14M9 7V5h6v2m-8 0 1 12h8l1-12" stroke-width="2" stroke-linecap="round" fill="none"/></symbol>
    <symbol id="i-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2M5 5l1.5 1.5M17.5 17.5 19 19M19 5l-1.5 1.5M5 19l1.5-1.5"/></symbol>
    <symbol id="i-moon" viewBox="0 0 24 24"><path d="M21 12.8A9 9 0 1 1 11.2 3 7 7 0 0 0 21 12.8Z"/></symbol>
    <symbol id="i-camera" viewBox="0 0 24 24"><path d="M4 7h4l2-2h4l2 2h4v12H4z" fill="none" stroke-width="2"/><circle cx="12" cy="13" r="4"/></symbol>
  </defs></svg>

  <header class="app-header">
    <div class="header-row">
      <h1 class="app-title">INVOBRA</h1>
      <button id="themeToggleBtn" class="btn ghost" aria-label="Cambiar tema"><svg class="i"><use id="themeIcon" href="#i-moon"/></svg></button>
    </div>
    <div class="toolbar" id="obra-toolbar">
      <div class="stack">
        <div class="row"><select id="obraSelect" aria-label="Seleccionar Obra" class="w-full"></select></div>
        <div class="row wrap">
          <button id="nuevaObraBtn" type="button" class="btn primary"><svg class="i"><use href="#i-plus"/></svg><span>Nueva</span></button>
          <button id="editObraBtn"  type="button" class="btn square"><svg class="i"><use href="#i-edit"/></svg></button>
          <button id="deleteObraBtn" type="button" class="btn danger square"><svg class="i"><use href="#i-trash"/></svg></button>
        </div>
      </div>
      <div id="alertContainer" class="alert-region" aria-live="polite"></div>
    </div>
  </header>

  <main class="app-main">
    <!-- INICIO: dashboard de obras con fotos -->
    <section id="view-inicio" class="view">
      <h2 class="view-title">Obras</h2>
      <div id="inicioGrid" class="grid-cards"></div>
    </section>

    <!-- AÑADIR: formulario para agregar ítems a la obra seleccionada -->
    <section id="view-anadir" class="card view hidden" aria-label="Añadir">
      <h2 id="formTitle">Agregar Ítem</h2>
      <form id="itemForm" class="grid" novalidate>
        <label><span>Nombre *</span><input id="itemNombre" required /></label>
        <label><span>Categoría *</span>
          <select id="itemCategoria" required>
            <option value="">— Seleccionar —</option>
            <option value="herramienta">Herramienta</option>
            <option value="material">Material</option>
          </select>
        </label>
        <label id="subtipoGroup"><span>Subtipo</span>
          <select id="itemSubtipo">
            <option value="">—</option>
            <option value="electrica">Eléctrica</option>
            <option value="manual">Manual</option>
          </select>
        </label>
        <label><span>Marca *</span>
          <select id="itemMarca" required>
            <option value="">—</option>
            <option value="__new__">Nueva marca…</option>
          </select>
        </label>
        <label id="marcaNuevaWrap" class="hidden"><span>Nueva marca</span><input id="itemMarcaNueva" /></label>
        <label><span>Cantidad</span><input id="itemCantidad" type="number" min="0" value="1" /></label>
        <label class="full"><span>Ubicación</span><input id="itemUbicacion" placeholder="ej: Almacén 1 / Estante A" /></label>
        <label class="full"><span>Observaciones</span><textarea id="itemObservaciones" rows="3" placeholder="Notas adicionales..."></textarea></label>
        <div class="row">
          <button id="submitBtn" type="submit" class="btn primary">Agregar ítem</button>
          <button id="cancelBtn" type="reset" class="btn ghost">Cancelar</button>
        </div>
      </form>
    </section>

    <!-- INVENTARIO: ficha de obra + lista (sin +/-) -->
    <section id="view-inventario" class="view hidden" aria-labelledby="inventario">
      <div id="obraInfo" class="card compact"></div>
      <div class="card">
        <div class="row between">
          <h2 id="inventario">Inventario</h2>
          <div class="chips">
            <span class="chip">Visibles <strong id="visibleCount">0</strong></span>
            <span class="chip">Total <strong id="totalCount">0</strong></span>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Nombre</th><th>Cat.</th><th>Subtipo</th><th>Cant.</th>
                <th>Marca</th><th>Ubicación</th><th>Observaciones</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="8" class="empty">Selecciona una obra…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CATEGORÍAS (sin toolbar de obra) -->
    <section id="view-categorias" class="card view hidden" aria-label="Categorías">
      <h2 class="view-title">Categorías y Marcas</h2>
      <div class="row wrap">
        <label>
          <span>Obra</span>
          <select id="catObra"><option value="all">Todas</option>
          </select>
        </label>        
        <label>
          <span>Categoría</span>
          <select id="catCategoria">
            <option value="ambas">Ambas</option>
            <option value="herramienta">Herramienta</option>
            <option value="material">Material</option>
          </select>
        </label>
        <label id="catSubtipoWrap">
          <span>Subtipo</span>
          <select id="catSubtipo">
            <option value="all">Todas</option>
            <option value="ambas">Ambas</option>
            <option value="electrica">Eléctrica</option>
            <option value="manual">Manual</option>
          </select>
        </label>
        <label>
          <span>Marca</span>
          <select id="catMarca"><option value="all">Todas</option></select>
        </label>
      </div>
      <div class="separator"></div>
      <div id="catSummary" class="muted"></div>
      <div id="catResults" class="grid" style="grid-template-columns:1fr;gap:8px"></div>
    </section>

    <!-- DATOS -->
    <section id="view-datos" class="card view hidden" aria-label="Datos">
      <h2 class="view-title">Datos</h2>
      <div class="row">
        <button id="downloadPdfBtn" class="btn primary">
          <svg class="i"><use href="#i-download"/></svg>
          Descargar Inventario PDF
        </button>
      </div>
      <p class="muted">Descarga un archivo de texto con todo el inventario de la obra seleccionada, ordenado por categorías.</p>
    </section>
  </main>

  <!-- TABS -->
  <nav class="tabbar" aria-label="Navegación">
    <a href="#inicio" class="tab" id="nav-inicio"><svg class="i"><use href="#i-home"/></svg><span>Inicio</span></a>
    <a href="#anadir" class="tab" id="nav-anadir"><svg class="i"><use href="#i-plus"/></svg><span>Añadir</span></a>
    <a href="#inventario" class="tab" id="nav-inventario"><svg class="i"><use href="#i-list"/></svg><span>Inventario</span></a>
    <a href="#categorias" class="tab" id="nav-categorias"><svg class="i"><use href="#i-cats"/></svg><span>Categorías</span></a>
    <a href="#datos" class="tab" id="nav-datos"><svg class="i"><use href="#i-download"/></svg><span>Datos</span></a>
  </nav>

  <!-- MODAL OBRAS -->
  <dialog id="obraModal" aria-labelledby="obraModalTitle" aria-modal="true" role="dialog">
    <form id="obraForm" class="dialog-card" novalidate>
      <header class="dialog-head">
        <h3 id="obraModalTitle">Nueva Obra</h3>
        <button type="button" class="btn ghost close-btn" aria-label="Cerrar">✕</button>
      </header>
      <div class="dialog-body">
        <label class="full"><span>Nombre de la Obra *</span><input id="obraNombre" required /><small id="obraNombre-error" class="error"></small></label>
      </div>
      <footer class="dialog-foot">
        <button id="obraDeleteBtn" type="button" class="btn danger hidden">Eliminar</button>
        <div class="spacer"></div>
        <button id="obraCancelBtn" type="button" class="btn ghost close-btn">Cancelar</button>
        <button id="obraSubmitBtn" type="submit" class="btn primary">Guardar</button>
      </footer>
    </form>
  </dialog>

  <script>
    // ========================================================
    // INVOBRA - Día/Noche + Inicio (fotos) + Inventario compacto + Categorías
    // ========================================================

    // ---------- Utils ----------
    const qs = (s, r=document) => r.querySelector(s);
    const qsa = (s, r=document) => [...r.querySelectorAll(s)];
    const show = el => el && el.classList.remove('hidden');
    const hide = el => el && el.classList.add('hidden');
    function escapeHtml(s){ return String(s||'').replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[c]); }
    function group(arr, fn){ return arr.reduce((m,x)=>{ const k=fn(x); (m[k]??=[]).push(x); return m; },{}); }
    function downloadFile(name, mime, content){ const blob = new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function fmtDate(d=new Date()){ return d.toLocaleString('es-ES',{hour12:false}); }

    function toast(type, msg){
      const box = qs('#alertContainer'); if(!box) return;
      box.textContent = msg;
      box.style.color = type==='error' ? '#ff8a8a' : '#b2f5bf';
      setTimeout(()=>{ box.textContent=''; }, 2500);
    }

    // ---------- Estado ----------
    const state = {
      obras: [],
      items: [], // solo de obra seleccionada
      allItems: [], // todos los items para sugerencias
      selectedObraId: localStorage.getItem('obraId') || '',
      editingItemId: '',
    };
    const BRANDS = new Set();
    const obraImages = JSON.parse(localStorage.getItem('obraImages')||'{}');

    // ---------- API ----------
    const API = {
      async obrasList(){ const r=await fetch('/.netlify/functions/obras'); if(!r.ok) throw new Error('Obras'); return r.json(); },
      async obraCreate(nombre){ const r=await fetch('/.netlify/functions/obras',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre})}); if(r.status===409) throw new Error('Duplicado'); if(!r.ok) throw new Error('Crear obra'); return r.json(); },
      async obraUpdate(id,nombre){ const r=await fetch(`/.netlify/functions/obras?id=${encodeURIComponent(id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre})}); if(!r.ok) throw new Error('Actualizar obra'); return r.json(); },
      async obraDelete(id){ const r=await fetch(`/.netlify/functions/obras?id=${encodeURIComponent(id)}`,{method:'DELETE'}); if(!r.ok) throw new Error('Eliminar obra'); return true; },
      async itemsByObra(obraId){ const r=await fetch(`/.netlify/functions/items?obraId=${encodeURIComponent(obraId)}`); if(!r.ok) throw new Error('Items'); return r.json(); },
      async itemsAll(){ const r=await fetch('/.netlify/functions/items'); if(!r.ok) throw new Error('Items all'); return r.json(); },
      async itemCreate(payload){ const r=await fetch('/.netlify/functions/items',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('Crear item'); return r.json(); },
      async itemUpdate(id, payload){ const r=await fetch(`/.netlify/functions/items?id=${encodeURIComponent(id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); if(!r.ok) throw new Error('Actualizar item'); return r.json(); },
      async itemDelete(id){ const r=await fetch(`/.netlify/functions/items?id=${encodeURIComponent(id)}`,{method:'DELETE'}); if(!r.ok) throw new Error('Eliminar item'); return true; },
      async getItemSuggestions(query){ const r=await fetch(`/.netlify/functions/item-templates?name=${encodeURIComponent(query)}`); if(!r.ok) return null; return r.json(); },
      async saveItemTemplate(name, category, subtype){ await fetch('/.netlify/functions/item-templates/upsert',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,category,subtype})}); },
    };

    // ---------- Inicio ----------
    window.addEventListener('DOMContentLoaded', init);
    async function init(){
      applyTheme(localStorage.getItem('theme')||'dark');
      bindListeners();
      await loadObras();
      await loadAllItems(); // Para sugerencias
      renderObrasSelect();
      if (state.selectedObraId) await loadInventario();
      // Asegurar que inicie en página Inicio
      if(!location.hash) location.hash = '#inicio';
      applyRoute();
    }

    // ---------- Cargar todos los items para sugerencias ----------
    async function loadAllItems(){
      try{ state.allItems = await API.itemsAll(); }catch{ state.allItems = []; }
    }

    // ---------- Listeners ----------
    let __bound=false;
    function bindListeners(){ if(__bound) return; __bound=true;
      // Tema
      qs('#themeToggleBtn')?.addEventListener('click', ()=>{
        const next = (document.documentElement.getAttribute('data-theme')==='light')?'dark':'light';
        applyTheme(next);
      });

      // Toolbar obras
      qs('#nuevaObraBtn')?.addEventListener('click', ()=> openObraModal());
      qs('#editObraBtn')?.addEventListener('click', ()=>{ const id=state.selectedObraId; if(!id) return; const obra=state.obras.find(o=>o.id===id); openObraModal({mode:'edit', obra}); });
      qs('#deleteObraBtn')?.addEventListener('click', async ()=>{ const id=state.selectedObraId; if(!id) return; if(confirm('¿Eliminar esta obra y todo su inventario?')){ await API.obraDelete(id); state.selectedObraId=''; state.items=[]; await loadObras(); renderObrasSelect(); renderObraInfo(); renderTable(); }});
      qs('#obraSelect')?.addEventListener('change', async (e)=>{ state.selectedObraId = e.target.value; localStorage.setItem('obraId', state.selectedObraId||''); renderObrasSelect(); await loadInventario(); renderObraInfo(); });

      // Modal obras
      const modal = qs('#obraModal');
      modal?.addEventListener('click', (e)=>{ if(e.target.classList?.contains('close-btn')) closeObraModal(); });
      modal?.addEventListener('cancel', (e)=>{ e.preventDefault(); closeObraModal(); });
      qs('#obraCancelBtn')?.addEventListener('click', closeObraModal);
      qs('#obraForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); await submitObraForm(); });

      // Form ítem (Añadir) - AUTOCOMPLETADO
      setupItemNameAutocomplete();
      
      qs('#itemForm')?.addEventListener('submit', async (e)=>{ e.preventDefault(); if(!state.selectedObraId){ toast('error','Selecciona una obra'); return; } await saveNewItem(); });
      qs('#itemCategoria')?.addEventListener('change', (e)=>{ const stg=qs('#subtipoGroup'); if(stg) stg.style.display = (e.target.value==='herramienta') ? 'block' : 'none'; });
      qs('#itemMarca')?.addEventListener('change', (e)=>{ const wrap=qs('#marcaNuevaWrap'); if(!wrap) return; if(e.target.value==='__new__'){ show(wrap); qs('#itemMarcaNueva')?.focus(); } else hide(wrap); });
      qs('#cancelBtn')?.addEventListener('click', resetItemForm);

      // Tabla inventario
      qs('#tableBody')?.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const tr = btn.closest('tr'); const id = tr?.dataset.id; if(!id) return;
        const action = btn.dataset.action; const item = state.items.find(i=>i.id===id); if(!item) return;

        if(action==='delete'){
          if(!confirm('¿Eliminar ítem?')) return; await API.itemDelete(id); await loadInventario(); return;
        }
        if(action==='edit'){
          state.editingItemId = id; renderTable(); return;
        }
        if(action==='save'){
          const payload = collectRowEdits(tr, item);
          await API.itemUpdate(id, payload);
          // ¿se movió de obra?
          if(payload.obra_id && payload.obra_id !== state.selectedObraId){ 
            toast('ok','Ítem movido a otra obra'); 
            // Recargar inventario de la obra actual
            await loadInventario();
          }
          state.editingItemId=''; await loadInventario(); return;
        }
        if(action==='cancel'){
          state.editingItemId=''; renderTable(); return;
        }
      });

      // Botón descargar PDF
      qs('#downloadPdfBtn')?.addEventListener('click', downloadInventarioPDF);

      // Router
      window.addEventListener('hashchange', applyRoute);
    }

    // ---------- Autocompletado nombre ítem ----------
    function setupItemNameAutocomplete(){
      const input = qs('#itemNombre');
      const container = qs('#itemForm');
      if(!input || !container) return;

      let suggestionsDiv = null;

      input.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        
        if(suggestionsDiv){
          suggestionsDiv.remove();
          suggestionsDiv = null;
        }

        if(query.length < 2) return;

        // Buscar sugerencias en items existentes
        const suggestions = [...new Set(state.allItems
          .filter(item => item.nombre && item.nombre.toLowerCase().includes(query))
          .map(item => ({
            nombre: item.nombre,
            categoria: item.categoria,
            subtipo: item.subtipo
          }))
          .slice(0, 5))];

        if(suggestions.length === 0) return;

        suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'suggestions-dropdown';
        suggestionsDiv.innerHTML = suggestions.map(s => 
          `<div class="suggestion-item" data-nombre="${escapeHtml(s.nombre)}" data-categoria="${s.categoria||''}" data-subtipo="${s.subtipo||''}">
            ${escapeHtml(s.nombre)} <span class="suggestion-meta">(${s.categoria}${s.subtipo ? ' - '+s.subtipo : ''})</span>
          </div>`
        ).join('');

        input.parentNode.appendChild(suggestionsDiv);

        // Click en sugerencia
        suggestionsDiv.addEventListener('click', (e) => {
          const item = e.target.closest('.suggestion-item');
          if(!item) return;

          const nombre = item.dataset.nombre;
          const categoria = item.dataset.categoria;
          const subtipo = item.dataset.subtipo;

          // Rellenar campos
          input.value = nombre;
          qs('#itemCategoria').value = categoria || '';
          qs('#itemSubtipo').value = subtipo || '';

          // Mostrar/ocultar subtipo según categoría
          const stg = qs('#subtipoGroup');
          if(stg) stg.style.display = (categoria === 'herramienta') ? 'block' : 'none';

          suggestionsDiv.remove();
          suggestionsDiv = null;
        });
      });

      // Cerrar sugerencias al hacer click fuera
      document.addEventListener('click', (e) => {
        if(!input.contains(e.target) && suggestionsDiv && !suggestionsDiv.contains(e.target)){
          suggestionsDiv.remove();
          suggestionsDiv = null;
        }
      });
    }

    function applyTheme(mode){
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
      const use = qs('#themeIcon'); if(use) use.setAttribute('href', mode==='light' ? '#i-moon' : '#i-sun');
    }

    // ---------- Obras ----------
    async function loadObras(){ try{ state.obras = await API.obrasList(); }catch{ toast('error','No se pudieron cargar obras'); } }
    function renderObrasSelect(){
      const sel = qs('#obraSelect'); if(!sel) return;
      sel.innerHTML = `<option value="">— Seleccionar Obra —</option>` + state.obras.map(o=>`<option value="${o.id}" ${o.id===state.selectedObraId?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
    }

    function openObraModal({mode='create', obra=null}={}){
      const m = qs('#obraModal'); const name = qs('#obraNombre'); const delBtn = qs('#obraDeleteBtn');
      name.value = obra?.nombre || ''; name.dataset.mode = mode; name.dataset.id = obra?.id || '';
      qs('#obraModalTitle').textContent = mode==='edit' ? 'Editar Obra' : 'Nueva Obra';
      if(mode==='edit'){ show(delBtn); delBtn.onclick = async ()=>{ if(confirm('¿Eliminar esta obra y su inventario?')){ await API.obraDelete(obra.id); closeObraModal(); await loadObras(); state.selectedObraId=''; renderObrasSelect(); state.items=[]; renderObraInfo(); renderTable(); } }; }
      else { hide(delBtn); delBtn.onclick=null; }
      m.showModal();
    }
    function closeObraModal(){ qs('#obraModal')?.close(); }
    async function submitObraForm(){
      const nameEl = qs('#obraNombre'); const nombre = nameEl.value.trim(); if(!nombre){ qs('#obraNombre-error').textContent='Nombre requerido'; return; }
      const mode = nameEl.dataset.mode||'create'; const id = nameEl.dataset.id||'';
      try{
        if(mode==='edit'){ await API.obraUpdate(id, nombre); toast('ok','Obra actualizada'); }
        else { const o = await API.obraCreate(nombre); state.selectedObraId = o.id; localStorage.setItem('obraId', o.id); toast('ok','Obra creada'); }
        closeObraModal(); await loadObras(); renderObrasSelect(); await loadInventario(); renderObraInfo();
      }catch(e){ toast('error', e.message||'Error obra'); }
    }

    // ---------- Inventario ----------
    async function loadInventario(){
      if(!state.selectedObraId){ state.items=[]; renderObraInfo(); renderTable(); return; }
      try{ state.items = await API.itemsByObra(state.selectedObraId); }catch{ state.items=[]; toast('error','No se pudo cargar inventario'); }
      BRANDS.clear(); state.items.forEach(i=>{ if(i.marca) BRANDS.add(i.marca); });
      renderBrandsSelect(); renderObraInfo(); renderTable();
    }

    function renderObraInfo(){
      const box = qs('#obraInfo'); if(!box) return;
      if(!state.selectedObraId){ box.innerHTML = '<div class="muted">Selecciona una obra para ver su resumen.</div>'; return; }
      const obra = state.obras.find(o=>o.id===state.selectedObraId); const items = state.items;
      const total = items.length; const unidades = items.reduce((s,i)=>s+(i.cantidad||0),0);
      const cats = Object.entries(group(items, i=>i.categoria)).map(([k,v])=>`${k}: ${v.length}`).join(' · ')||'—';
      const subs = Object.entries(group(items.filter(i=>i.categoria==='herramienta'), i=>i.subtipo||'—')).map(([k,v])=>`${k}: ${v.length}`).join(' · ')||'—';
      box.innerHTML = `
        <div class="row between"><h2 style="margin:0">${escapeHtml(obra?.nombre||'Obra')}</h2><div class="chips"><span class="chip">Ítems ${total}</span><span class="chip">Unid. ${unidades}</span></div></div>
        <div class="muted" style="margin-top:6px">Categorías: ${escapeHtml(cats)}<br/>Subtipos: ${escapeHtml(subs)}</div>
      `;
    }

    function renderBrandsSelect(){
      const sel = qs('#itemMarca'); if(!sel) return;
      const opts = ['<option value="">—</option><option value="__new__">Nueva marca…</option>']
        .concat([...BRANDS].sort().map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`));
      sel.innerHTML = opts.join('');
    }

    async function saveNewItem(){
      const cat = qs('#itemCategoria').value;
      const marcaSel = qs('#itemMarca').value;
      const payload = {
        obra_id: state.selectedObraId,
        nombre: qs('#itemNombre').value.trim(),
        categoria: cat,
        subtipo: cat==='herramienta' ? (qs('#itemSubtipo').value||null) : null,
        cantidad: Math.max(0, parseInt(qs('#itemCantidad').value,10) || 0),
        marca: (marcaSel==='__new__' ? (qs('#itemMarcaNueva').value.trim()) : marcaSel) || '',
        ubicacion: qs('#itemUbicacion').value.trim() || '',
        observaciones: qs('#itemObservaciones').value.trim() || ''
      };
      if(!payload.nombre || !payload.categoria || !payload.marca){ toast('error','Completa nombre, categoría y marca'); return; }
      
      try{ 
        await API.itemCreate(payload); 
        // Guardar template para futuras sugerencias
        await API.saveItemTemplate(payload.nombre, payload.categoria, payload.subtipo);
        await loadInventario(); 
        await loadAllItems(); // Actualizar sugerencias
        resetItemForm(); 
        toast('ok','Ítem agregado'); 
      }
      catch{ toast('error','No se pudo agregar'); }
    }

    function resetItemForm(){ ['itemNombre','itemCategoria','itemSubtipo','itemMarca','itemMarcaNueva','itemCantidad','itemUbicacion','itemObservaciones']
      .forEach(id=>{ const el=qs('#'+id); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value= (id==='itemCantidad'?'1':''); }); hide(qs('#marcaNuevaWrap'));
    }

    function renderTable(){
      const tbody = qs('#tableBody'); const visEl = qs('#visibleCount'); const totEl = qs('#totalCount');
      if(!tbody) return;
      const total = state.items.length; let items = [...state.items];
      visEl && (visEl.textContent = String(items.length));
      totEl && (totEl.textContent = String(total));
      if(!state.selectedObraId){ tbody.innerHTML = '<tr><td colspan="8" class="empty">Selecciona una obra…</td></tr>'; return; }
      if(items.length===0){ tbody.innerHTML = '<tr><td colspan="8" class="empty">Sin resultados</td></tr>'; return; }
      tbody.innerHTML = items.map(i=> state.editingItemId===i.id ? rowEditHTML(i) : rowReadHTML(i) ).join('');
    }

    function rowReadHTML(i){
      return `<tr data-id="${i.id}">
        <td>${escapeHtml(i.nombre)}</td>
        <td>${i.categoria}</td>
        <td>${i.subtipo||'—'}</td>
        <td><strong>${i.cantidad||0}</strong></td>
        <td>${escapeHtml(i.marca||'')}</td>
        <td>${escapeHtml(i.ubicacion||'')}</td>
        <td>${escapeHtml(i.observaciones||'')}</td>
        <td><div class="row"><button class="btn" data-action="edit">Editar</button><button class="btn danger" data-action="delete">Eliminar</button></div></td>
      </tr>`;
    }

    function rowEditHTML(i){
      const obrasOpts = state.obras.map(o=>`<option value="${o.id}" ${o.id===i.obra_id?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
      return `<tr data-id="${i.id}">
        <td><input value="${escapeHtml(i.nombre)}" data-f="nombre" /></td>
        <td>
          <select data-f="categoria">
            <option value="herramienta" ${i.categoria==='herramienta'?'selected':''}>herramienta</option>
            <option value="material" ${i.categoria==='material'?'selected':''}>material</option>
          </select>
        </td>
        <td>
          <select data-f="subtipo">
            <option value="" ${!i.subtipo?'selected':''}>—</option>
            <option value="electrica" ${i.subtipo==='electrica'?'selected':''}>electrica</option>
            <option value="manual" ${i.subtipo==='manual'?'selected':''}>manual</option>
          </select>
        </td>
        <td><input type="number" min="0" value="${i.cantidad||0}" data-f="cantidad" /></td>
        <td><input value="${escapeHtml(i.marca||'')}" data-f="marca" /></td>
        <td><input value="${escapeHtml(i.ubicacion||'')}" data-f="ubicacion" /></td>
        <td><input value="${escapeHtml(i.observaciones||'')}" data-f="observaciones" /></td>
        <td>
          <div class="row wrap">
            <select data-f="obra_id">${obrasOpts}</select>
            <button class="btn" data-action="save">Guardar</button>
            <button class="btn ghost" data-action="cancel">Cancelar</button>
          </div>
        </td>
      </tr>`;
    }

    function collectRowEdits(tr, original){
      const get = sel => tr.querySelector(sel);
      const cat = get('select[data-f="categoria"]').value;
      const payload = {
        nombre: get('input[data-f="nombre"]').value.trim(),
        categoria: cat,
        subtipo: cat==='herramienta' ? (get('select[data-f="subtipo"]').value||null) : null,
        cantidad: Math.max(0, parseInt(get('input[data-f="cantidad"]').value,10)||0),
        marca: get('input[data-f="marca"]').value.trim(),
        ubicacion: get('input[data-f="ubicacion"]').value.trim(),
        observaciones: get('input[data-f="observaciones"]').value.trim(),
      };
      const obraId = get('select[data-f="obra_id"]').value; 
      if(obraId && obraId!==original.obra_id) payload.obra_id = obraId;
      return payload;
    }

    // ---------- Descargar PDF ----------
    async function downloadInventarioPDF(){
      if(!state.selectedObraId){ toast('error','Selecciona una obra'); return; }
      const obra = state.obras.find(o=>o.id===state.selectedObraId);
      if(!obra){ toast('error','Obra no encontrada'); return; }

      const items = state.items.sort((a,b) => a.nombre.localeCompare(b.nombre));
      
      let content = `INVENTARIO - ${obra.nombre.toUpperCase()}\n`;
      content += `Fecha: ${fmtDate()}\n`;
      content += `Total de ítems: ${items.length}\n`;
      content += `Total de unidades: ${items.reduce((s,i)=>s+(i.cantidad||0),0)}\n\n`;
      content += `${'='.repeat(80)}\n\n`;

      const categorias = group(items, i=>i.categoria);
      
      Object.entries(categorias).forEach(([cat, itemsCat]) => {
        content += `${cat.toUpperCase()}\n`;
        content += `${'-'.repeat(cat.length)}\n\n`;
        
        itemsCat.forEach((item, idx) => {
          content += `${idx + 1}. ${item.nombre}\n`;
          if(item.subtipo) content += `   Subtipo: ${item.subtipo}\n`;
          content += `   Cantidad: ${item.cantidad || 0}\n`;
          content += `   Marca: ${item.marca || 'N/A'}\n`;
          if(item.ubicacion) content += `   Ubicación: ${item.ubicacion}\n`;
          if(item.observaciones) content += `   Observaciones: ${item.observaciones}\n`;
          content += '\n';
        });
        
        content += '\n';
      });

      const filename = `inventario_${obra.nombre.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
      downloadFile(filename, 'text/plain', content);
      toast('ok', 'Inventario descargado');
    }

    // ---------- Inicio (grid de obras) ----------
    function renderInicio(){
      const grid = qs('#inicioGrid'); if(!grid) return;
      if(!state.obras.length){ grid.innerHTML='<div class="muted">No hay obras. Crea una con el botón "Nueva".</div>'; return; }
      grid.innerHTML = state.obras.map(o=>{
        const img = obraImages[o.id] || '';
        return `<div class="card-obra" data-obra="${o.id}">
          <img src="${img||'data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 200\'><rect width=\'400\' height=\'200\' fill=\'%23cfe0f5\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%233d5a80\' font-family=\'Arial\' font-size=\'22\'>Sin foto</text></svg>'}" alt="${escapeHtml(o.nombre)}" />
          <button class="btn change" data-action="foto" title="Cambiar foto"><svg class="i"><use href="#i-camera"/></svg></button>
          <div class="meta">${escapeHtml(o.nombre)}</div>
          <input type="file" accept="image/*" class="hidden" />
        </div>`;
      }).join('');

      grid.onclick = (e)=>{
        const card = e.target.closest('.card-obra'); if(!card) return;
        const id = card.dataset.obra;
        const change = e.target.closest('[data-action="foto"]');
        if(change){
          const input = card.querySelector('input[type="file"]');
          input.onchange = async ()=>{
            const f = input.files?.[0]; if(!f) return;
            const fr = new FileReader(); fr.onloa