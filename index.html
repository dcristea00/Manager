<!-- File: /inventory/brutalist-inventario.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de Obras — Brutal</title>
  <style>
    /* === BRUTALISMO: tipografía monoespaciada, bordes gruesos, colores planos === */
    :root{
      --bg:#fefefe; --ink:#111; --muted:#999; --primary:#ffd400; --accent:#00e0b8; --danger:#ff4d4d;
      --pad:14px; --br:6px; --bw:3px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    /* Header */
    header{
      border-bottom:var(--bw) solid var(--ink);
      padding:calc(var(--pad) + 4px) var(--pad);
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background:var(--primary);
      position:sticky; top:0; z-index:10;
      box-shadow:6px 6px 0 #00000022;
    }
    h1{font-size:22px; margin:0; letter-spacing:.5px}
    .header-controls{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
    /* Controles */
    select, input[type="text"], input[type="number"], textarea{
      border:var(--bw) solid var(--ink); background:#fff; padding:10px; border-radius:0; min-height:44px;
    }
    button{
      border:var(--bw) solid var(--ink); background:#fff; padding:10px 14px; cursor:pointer; min-height:44px;
      box-shadow:4px 4px 0 #000; transition:transform .02s;
    }
    button:active{transform:translate(2px,2px); box-shadow:2px 2px 0 #000}
    .btn-primary{background:var(--accent)}
    .btn-secondary{background:#eaeaea}
    .btn-danger{background:var(--danger)}
    .file-label{display:inline-block}
    /* Layout */
    .container{max-width:1200px; margin:24px auto; padding:0 var(--pad); display:grid; gap:20px}
    .panel{
      border:var(--bw) solid var(--ink); padding:18px; background:#fff; box-shadow:8px 8px 0 #00000020;
    }
    .panel h2{margin:0 0 10px}
    /* Grid simple responsivo */
    .grid{display:grid; gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){ .grid.cols-3{grid-template-columns:1fr} }
    @media (max-width:700px){ .grid.cols-2{grid-template-columns:1fr} }
    /* Tabla */
    .table-wrap{overflow:auto; border:var(--bw) solid var(--ink)}
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:var(--bw) solid var(--ink); padding:10px; vertical-align:top}
    thead th{background:#fafafa; position:sticky; top:0}
    tr:hover td{background:#fffbe6}
    .qty-controls{display:flex; gap:6px; align-items:center}
    .btn-icon{width:36px; height:36px; display:inline-grid; place-items:center}
    /* Chips contadores */
    .counters{display:flex; gap:10px; flex-wrap:wrap; font-size:14px}
    .chip{border:var(--bw) solid var(--ink); padding:6px 10px; background:#fff}
    /* Alertas */
    .alert{border:var(--bw) solid var(--ink); padding:10px; margin:10px 0}
    .alert.success{background:#ddffde}
    .alert.error{background:#ffe0e0}
    /* Modal */
    dialog{border:var(--bw) solid var(--ink); padding:0; max-width:520px; width:92vw}
    dialog::backdrop{background:#00000080}
    .modal-header{display:flex; justify-content:space-between; align-items:center;
      padding:14px; background:#111; color:#fff}
    .modal-content{padding:16px}
    .close-btn{background:#fff}
    /* Utils */
    .hidden{display:none!important}
    .row-actions{display:flex; gap:6px; flex-wrap:wrap}
    .form-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    label{font-weight:700}
    small.muted{color:var(--muted)}
    /* Focus */
    :focus-visible{outline:3px solid #000; outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <h1>Inventario de Obras</h1>
    <div class="header-controls">
      <select id="obraSelect" aria-label="Seleccionar obra">
        <option value="">— Seleccionar Obra —</option>
      </select>
      <button type="button" id="nuevaObraBtn" class="btn-primary">Nueva Obra</button>
      <button type="button" id="exportBtn" class="btn-secondary">Exportar JSON</button>
      <label for="importFile" class="file-label btn-secondary" role="button" aria-controls="importFile">Importar JSON</label>
      <input type="file" id="importFile" class="hidden" accept=".json" />
    </div>
  </header>

  <main class="container">
    <section class="panel" aria-labelledby="como-usar">
      <h2 id="como-usar">Cómo usar</h2>
      <ol>
        <li>Click en <strong>Nueva Obra</strong> y créala.</li>
        <li>Selecciona la obra en el selector.</li>
        <li>Rellena el formulario para añadir ítems.</li>
        <li>Filtra por categoría/subtipo o busca por nombre.</li>
        <li>Ajusta cantidades con +/- en la tabla.</li>
        <li>Exporta/Importa tus datos en JSON.</li>
      </ol>
      <p><small class="muted">Todo se guarda en <code>localStorage</code> del navegador.</small></p>
    </section>

    <!-- Filtros -->
    <section class="panel" aria-labelledby="filtros">
      <h2 id="filtros">Filtros</h2>
      <div class="grid cols-3">
        <div>
          <label>Categoría</label>
          <div class="row-actions" role="group" aria-label="Categoría">
            <label><input type="radio" name="categoria" value="" checked> Todas</label>
            <label><input type="radio" name="categoria" value="herramienta"> Herramientas</label>
            <label><input type="radio" name="categoria" value="material"> Materiales</label>
          </div>
        </div>
        <div id="subtipoFilter">
          <label>Subtipo de Herramienta</label>
          <div class="row-actions" role="group" aria-label="Subtipo">
            <label><input type="radio" name="subtipo" value="" checked> Todos</label>
            <label><input type="radio" name="subtipo" value="electrica"> Eléctrica</label>
            <label><input type="radio" name="subtipo" value="manual"> Manual</label>
          </div>
        </div>
        <div>
          <label for="searchInput">Buscar por nombre</label>
          <input type="text" id="searchInput" placeholder="Escribe para buscar..." />
        </div>
      </div>
    </section>

    <!-- Formulario Ítems -->
    <section class="panel" aria-labelledby="formTitle">
      <h2 id="formTitle">Agregar Ítem</h2>
      <div id="alertContainer" aria-live="polite"></div>
      <form id="itemForm" novalidate>
        <div class="grid cols-3">
          <div>
            <label for="itemNombre">Nombre *</label>
            <input id="itemNombre" required />
            <div id="itemNombre-error" class="alert error hidden"></div>
          </div>
          <div>
            <label for="itemCategoria">Categoría *</label>
            <select id="itemCategoria" required>
              <option value="">— Seleccionar —</option>
              <option value="herramienta">Herramienta</option>
              <option value="material">Material</option>
            </select>
            <div id="itemCategoria-error" class="alert error hidden"></div>
          </div>
          <div id="subtipoGroup">
            <label for="itemSubtipo">Subtipo</label>
            <select id="itemSubtipo">
              <option value="">— Seleccionar —</option>
              <option value="electrica">Eléctrica</option>
              <option value="manual">Manual</option>
            </select>
            <div id="itemSubtipo-error" class="alert error hidden"></div>
          </div>
          <div>
            <label for="itemCantidad">Cantidad *</label>
            <input type="number" id="itemCantidad" min="0" required />
            <div id="itemCantidad-error" class="alert error hidden"></div>
          </div>
          <div>
            <label for="itemUnidad">Unidad *</label>
            <input id="itemUnidad" placeholder="ej: uds, kg, m" required />
            <div id="itemUnidad-error" class="alert error hidden"></div>
          </div>
          <div>
            <label for="itemUbicacion">Ubicación</label>
            <input id="itemUbicacion" placeholder="ej: Almacén 1 / Estante A" />
          </div>
          <div style="grid-column:1/-1">
            <label for="itemObservaciones">Observaciones</label>
            <textarea id="itemObservaciones" rows="3" placeholder="Notas adicionales..."></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" id="submitBtn" class="btn-primary">Agregar Ítem</button>
          <button type="button" id="cancelBtn" class="btn-secondary">Cancelar</button>
        </div>
      </form>
    </section>

    <!-- Tabla Inventario -->
    <section class="panel" aria-labelledby="inventario">
      <h2 id="inventario">Inventario</h2>
      <div class="counters">
        <div class="chip">Ítems visibles: <strong id="visibleCount">0</strong></div>
        <div class="chip">Total: <strong id="totalCount">0</strong></div>
      </div>
      <div class="table-wrap" role="region" aria-label="Tabla de inventario">
        <table>
          <thead>
            <tr>
              <th>Nombre</th><th>Categoría</th><th>Subtipo</th>
              <th>Cantidad</th><th>Unidad</th><th>Ubicación</th>
              <th>Observaciones</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center;padding:20px">Selecciona una obra para ver el inventario</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Modal Obras -->
  <dialog id="obraModal" aria-labelledby="obraModalTitle">
    <div class="modal-header">
      <h3 id="obraModalTitle">Nueva Obra</h3>
      <button type="button" class="close-btn btn-icon" aria-label="Cerrar" data-close>✕</button>
    </div>
    <div class="modal-content">
      <form id="obraForm" novalidate>
        <label for="obraNombre">Nombre de la Obra *</label>
        <input id="obraNombre" required />
        <div id="obraNombre-error" class="alert error hidden"></div>
        <div class="form-actions">
          <button type="submit" id="obraSubmitBtn" class="btn-primary">Crear Obra</button>
          <button type="button" id="obraCancelBtn" class="btn-secondary" data-close>Cancelar</button>
          <button type="button" id="obraDeleteBtn" class="btn-danger hidden">Eliminar Obra</button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    // === Configuración ==================================================================
    const CONFIG = { storageKey: 'obraInv_v1', version: 1 };

    // === Estado =========================================================================
    let state = {
      obras: [],
      items: [],
      selectedObraId: '',
      editingItemId: null,
      filters: { categoria: '', subtipo: '', search: '' }
    };

    // === Almacenamiento =================================================================
    const Storage = {
      load(){
        try{
          const raw = localStorage.getItem(CONFIG.storageKey);
          if(raw){
            const parsed = JSON.parse(raw);
            return { version: parsed.version||1, obras: parsed.obras||[], items: parsed.items||[] };
          }
        }catch(e){ console.error('Error load', e); }
        return this.defaults();
      },
      save(){
        try{
          localStorage.setItem(CONFIG.storageKey, JSON.stringify({
            version: CONFIG.version, obras: state.obras, items: state.items
          }));
        }catch(e){ console.error('Error save', e); }
      },
      export(){
        const data = { version: CONFIG.version, obras: state.obras, items: state.items };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `inventario-obras-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      },
      async import(file){
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || !Array.isArray(data.obras) || !Array.isArray(data.items)) throw new Error('Formato inválido');
        state.obras = data.obras; state.items = data.items; if(!state.obras.find(o=>o.id===state.selectedObraId)) state.selectedObraId='';
        Storage.save();
      },
      defaults(){
        return {
          version: 1,
          obras: [
            { id: 'obra_001', nombre: 'Residencial Sur' },
            { id: 'obra_002', nombre: 'Edificio Comercial Norte' }
          ],
          items: [
            { id:'itm_001', obraId:'obra_001', nombre:'Taladro Bosch GSB 13', categoria:'herramienta', subtipo:'electrica', cantidad:3, unidad:'uds', ubicacion:'Almacén 1 / Estante B', observaciones:'Revisión mensual' },
            { id:'itm_002', obraId:'obra_001', nombre:'Cemento CEM II', categoria:'material', subtipo:'', cantidad:40, unidad:'sacos', ubicacion:'Patio', observaciones:'' },
            { id:'itm_003', obraId:'obra_001', nombre:'Martillo Stanley 20oz', categoria:'herramienta', subtipo:'manual', cantidad:5, unidad:'uds', ubicacion:'Almacén 1 / Estante A', observaciones:'Mango de fibra' },
            { id:'itm_004', obraId:'obra_002', nombre:'Sierra Circular Makita', categoria:'herramienta', subtipo:'electrica', cantidad:2, unidad:'uds', ubicacion:'Taller', observaciones:'Incluye disco de corte' },
            { id:'itm_005', obraId:'obra_002', nombre:'Arena Gruesa', categoria:'material', subtipo:'', cantidad:15, unidad:'m³', ubicacion:'Patio Trasero', observaciones:'Para hormigón' }
          ]
        }
      }
    };

    // === Utilidades =====================================================================
    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : `id_${Date.now()}_${Math.random().toString(36).slice(2,9)}`);
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => [...el.querySelectorAll(s)];
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    // === Validaciones ===================================================================
    const Validate = {
      obraNombre(nombre, excludeId=null){
        if(!nombre?.trim()) return 'El nombre es obligatorio';
        const dup = state.obras.some(o => o.id !== excludeId && o.nombre.trim().toLowerCase() === nombre.trim().toLowerCase());
        return dup ? 'Ya existe una obra con este nombre' : '';
      },
      item(data, obraId, excludeId=null){
        const errors = {};
        if(!data.nombre?.trim()) errors.nombre = 'El nombre es obligatorio';
        const dup = state.items.some(it => it.id !== excludeId && it.obraId===obraId &&
          it.nombre.trim().toLowerCase() === data.nombre.trim().toLowerCase() &&
          it.categoria === data.categoria && (it.subtipo||'') === (data.subtipo||''));
        if(!errors.nombre && dup) errors.nombre = 'Ya existe un ítem con mismo nombre/categoría/subtipo';
        if(!data.categoria) errors.categoria = 'La categoría es obligatoria';
        if(data.categoria==='herramienta' && !data.subtipo) errors.subtipo = 'El subtipo es obligatorio para herramientas';
        const cantidad = Number.parseInt(data.cantidad,10);
        if(Number.isNaN(cantidad) || cantidad < 0) errors.cantidad = 'Cantidad debe ser ≥ 0';
        if(!data.unidad?.trim()) errors.unidad = 'La unidad es obligatoria';
        return errors;
      }
    };

    // === Render =================================================================================
    function renderObrasSelect(){
      const sel = qs('#obraSelect');
      const prev = sel.value;
      sel.innerHTML = `<option value="">— Seleccionar Obra —</option>` +
        state.obras.map(o=>`<option value="${o.id}">${o.nombre}</option>`).join('');
      sel.value = state.selectedObraId || prev || '';
    }

    function renderCounts(filtered){
      qs('#totalCount').textContent = state.items.filter(i => i.obraId === state.selectedObraId).length;
      qs('#visibleCount').textContent = filtered.length;
    }

    function renderTable(){
      const tbody = qs('#tableBody');
      if(!state.selectedObraId){
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px">Selecciona una obra para ver el inventario</td></tr>`;
        renderCounts([]);
        return;
      }
      const filtered = applyFilters();
      if(filtered.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px">Sin resultados</td></tr>`;
        renderCounts(filtered);
        return;
      }
      tbody.innerHTML = filtered.map(it=>`
        <tr data-id="${it.id}">
          <td>${it.nombre}</td>
          <td>${capitalize(it.categoria)}</td>
          <td>${it.categoria==='herramienta' ? (it.subtipo || '—') : '—'}</td>
          <td>
            <div class="qty-controls">
              <button class="btn-icon" data-action="dec" title="Disminuir">−</button>
              <strong>${it.cantidad}</strong>
              <button class="btn-icon" data-action="inc" title="Aumentar">+</button>
            </div>
          </td>
          <td>${it.unidad}</td>
          <td>${it.ubicacion || '—'}</td>
          <td>${it.observaciones || '—'}</td>
          <td class="row-actions">
            <button class="btn-secondary" data-action="edit">Editar</button>
            <button class="btn-danger" data-action="delete">Eliminar</button>
          </td>
        </tr>
      `).join('');
      renderCounts(filtered);
    }

    function capitalize(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }

    // === Filtros ================================================================================
    function applyFilters(){
      const {categoria, subtipo, search} = state.filters;
      return state.items.filter(i => i.obraId === state.selectedObraId)
        .filter(i => !categoria || i.categoria === categoria)
        .filter(i => categoria!=='herramienta' || !subtipo || (i.subtipo||'') === subtipo)
        .filter(i => !search || i.nombre.toLowerCase().includes(search.toLowerCase()));
    }

    // === Modal Obras =============================================================================
    const obraModal = qs('#obraModal');
    function openObraModal({mode='create', obra=null}={}){
      qs('#obraModalTitle').textContent = mode==='edit' ? 'Editar Obra' : 'Nueva Obra';
      const submit = qs('#obraSubmitBtn');
      submit.textContent = mode==='edit' ? 'Guardar Cambios' : 'Crear Obra';
      const del = qs('#obraDeleteBtn');
      if(mode==='edit'){ show(del); del.onclick = () => { deleteObra(obra.id); closeObraModal(); }; }
      else { hide(del); del.onclick = null; }
      const nameInput = qs('#obraNombre');
      nameInput.value = obra?.nombre || '';
      nameInput.dataset.mode = mode;
      nameInput.dataset.id = obra?.id || '';
      hide(qs('#obraNombre-error'));
      obraModal.showModal(); // <- FIX: abrir modal
      setTimeout(()=>nameInput.focus(), 50);
    }
    function closeObraModal(){ obraModal.close(); }

    // === Obras (CRUD) ============================================================================
    function createObra(nombre){
      const err = Validate.obraNombre(nombre);
      if(err){ showError('#obraNombre-error', err); return null; }
      const obra = { id: uid(), nombre: nombre.trim() };
      state.obras.push(obra);
      state.selectedObraId = obra.id;
      Storage.save();
      renderObrasSelect(); renderTable();
      toast('success', `Obra «${obra.nombre}» creada`);
      return obra;
    }
    function updateObra(id, nombre){
      const err = Validate.obraNombre(nombre, id);
      if(err){ showError('#obraNombre-error', err); return null; }
      const obra = state.obras.find(o=>o.id===id);
      if(!obra) return null;
      obra.nombre = nombre.trim();
      Storage.save(); renderObrasSelect();
      toast('success', 'Obra actualizada');
      return obra;
    }
    function deleteObra(id){
      const obra = state.obras.find(o=>o.id===id);
      state.obras = state.obras.filter(o=>o.id!==id);
      state.items = state.items.filter(i=>i.obraId!==id);
      if(state.selectedObraId===id) state.selectedObraId='';
      Storage.save(); renderObrasSelect(); renderTable();
      toast('success', `Obra «${obra?.nombre||''}» eliminada`);
    }

    // === Ítems (CRUD) ============================================================================
    function readItemForm(){
      return {
        nombre: qs('#itemNombre').value,
        categoria: qs('#itemCategoria').value,
        subtipo: qs('#itemCategoria').value==='herramienta' ? qs('#itemSubtipo').value : '',
        cantidad: qs('#itemCantidad').value,
        unidad: qs('#itemUnidad').value,
        ubicacion: qs('#itemUbicacion').value,
        observaciones: qs('#itemObservaciones').value
      };
    }
    function resetItemForm(){
      qs('#itemForm').reset();
      state.editingItemId = null;
      qs('#submitBtn').textContent = 'Agregar Ítem';
      qs('#formTitle').textContent = 'Agregar Ítem';
      hideErrors();
    }
    function showError(sel, msg){ const el = qs(sel); el.textContent = msg; show(el); }
    function hideErrors(){ qsa('.alert.error').forEach(hide); }
    function saveNewItem(){
      const data = readItemForm();
      const errors = Validate.item(data, state.selectedObraId);
      hideErrors();
      if(Object.keys(errors).length){
        if(errors.nombre) showError('#itemNombre-error', errors.nombre);
        if(errors.categoria) showError('#itemCategoria-error', errors.categoria);
        if(errors.subtipo) showError('#itemSubtipo-error', errors.subtipo);
        if(errors.cantidad) showError('#itemCantidad-error', errors.cantidad);
        if(errors.unidad) showError('#itemUnidad-error', errors.unidad);
        toast('error', 'Revisa los campos obligatorios');
        return;
      }
      const item = {
        id: uid(), obraId: state.selectedObraId, nombre: data.nombre.trim(),
        categoria: data.categoria, subtipo: data.categoria==='herramienta'?data.subtipo:'',
        cantidad: parseInt(data.cantidad,10), unidad: data.unidad.trim(),
        ubicacion: data.ubicacion?.trim()||'', observaciones: data.observaciones?.trim()||''
      };
      state.items.push(item);
      Storage.save(); renderTable(); resetItemForm(); toast('success','Ítem agregado');
    }
    function saveEditedItem(){
      const data = readItemForm();
      const errors = Validate.item(data, state.selectedObraId, state.editingItemId);
      hideErrors();
      if(Object.keys(errors).length){
        if(errors.nombre) showError('#itemNombre-error', errors.nombre);
        if(errors.categoria) showError('#itemCategoria-error', errors.categoria);
        if(errors.subtipo) showError('#itemSubtipo-error', errors.subtipo);
        if(errors.cantidad) showError('#itemCantidad-error', errors.cantidad);
        if(errors.unidad) showError('#itemUnidad-error', errors.unidad);
        toast('error', 'Revisa los campos obligatorios');
        return;
      }
      const it = state.items.find(i=>i.id===state.editingItemId);
      if(!it) return;
      it.nombre = data.nombre.trim();
      it.categoria = data.categoria;
      it.subtipo = data.categoria==='herramienta' ? data.subtipo : '';
      it.cantidad = parseInt(data.cantidad,10);
      it.unidad = data.unidad.trim();
      it.ubicacion = data.ubicacion?.trim()||'';
      it.observaciones = data.observaciones?.trim()||'';
      Storage.save(); renderTable(); resetItemForm(); toast('success','Ítem actualizado');
    }

    // === Notificaciones ========================================================================
    function toast(type, msg){
      const container = qs('#alertContainer');
      container.innerHTML = `<div class="alert ${type==='error'?'error':'success'}">${msg}</div>`;
      setTimeout(()=>{ container.innerHTML=''; }, 1800);
    }

    // === Listeners ==============================================================================
    function addEventListeners(){
      // FIX BOTÓN NUEVA OBRA -> abre modal
      qs('#nuevaObraBtn').addEventListener('click', ()=> openObraModal());

      // Modal: cerrar (x), cancelar, backdrop esc
      obraModal.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeObraModal(); });
      obraModal.addEventListener('cancel', (e)=>{ e.preventDefault(); closeObraModal(); });

      // Form Obra
      qs('#obraForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const mode = qs('#obraNombre').dataset.mode || 'create';
        const id = qs('#obraNombre').dataset.id || '';
        const nombre = qs('#obraNombre').value;
        if(mode==='edit'){ updateObra(id, nombre) && closeObraModal(); }
        else { createObra(nombre) && closeObraModal(); }
      });

      // Selector de obras
      qs('#obraSelect').addEventListener('change', (e)=>{
        state.selectedObraId = e.target.value;
        Storage.save(); renderTable();
      });

      // Import / Export
      qs('#exportBtn').addEventListener('click', ()=> Storage.export());
      qs('#importFile').addEventListener('change', async (e)=>{
        if(!e.target.files?.length) return;
        try{
          await Storage.import(e.target.files[0]);
          renderObrasSelect(); renderTable();
          toast('success','Datos importados');
        }catch(err){ toast('error', err.message || 'Error al importar'); }
        e.target.value='';
      });

      // Form Ítem
      qs('#itemCategoria').addEventListener('change', (e)=>{
        const cat = e.target.value;
        // Por qué: el subtipo solo aplica a herramientas.
        qs('#subtipoGroup').style.display = (cat==='herramienta') ? 'block' : 'none';
      });
      qs('#itemForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!state.selectedObraId){ toast('error','Selecciona una obra primero'); return; }
        if(state.editingItemId) saveEditedItem(); else saveNewItem();
      });
      qs('#cancelBtn').addEventListener('click', resetItemForm);

      // Filtros
      qsa('input[name="categoria"]').forEach(r=>r.addEventListener('change',(e)=>{
        state.filters.categoria = e.target.value; renderTable();
        qs('#subtipoFilter').style.display = (state.filters.categoria==='herramienta') ? 'block' : 'none';
      }));
      qsa('input[name="subtipo"]').forEach(r=>r.addEventListener('change',(e)=>{
        state.filters.subtipo = e.target.value; renderTable();
      }));
      qs('#searchInput').addEventListener('input',(e)=>{ state.filters.search = e.target.value; renderTable(); });

      // Tabla acciones
      qs('#tableBody').addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const tr = e.target.closest('tr'); const id = tr?.dataset.id; if(!id) return;
        const action = btn.dataset.action;
        const item = state.items.find(i=>i.id===id);
        if(action==='inc'){ item.cantidad += 1; Storage.save(); renderTable(); }
        if(action==='dec'){ item.cantidad = Math.max(0, item.cantidad - 1); Storage.save(); renderTable(); }
        if(action==='delete'){
          if(confirm('¿Eliminar ítem?')){ state.items = state.items.filter(i=>i.id!==id); Storage.save(); renderTable(); }
        }
        if(action==='edit'){
          state.editingItemId = id;
          qs('#formTitle').textContent = 'Editar Ítem';
          qs('#submitBtn').textContent = 'Guardar Cambios';
          qs('#itemNombre').value = item.nombre;
          qs('#itemCategoria').value = item.categoria;
          qs('#subtipoGroup').style.display = (item.categoria==='herramienta') ? 'block' : 'none';
          qs('#itemSubtipo').value = item.subtipo || '';
          qs('#itemCantidad').value = item.cantidad;
          qs('#itemUnidad').value = item.unidad;
          qs('#itemUbicacion').value = item.ubicacion;
          qs('#itemObservaciones').value = item.observaciones;
          window.scrollTo({top:0, behavior:'smooth'});
        }
      });

      // Editar obra actual desde selector (doble click)
      qs('#obraSelect').addEventListener('dblclick', (e)=>{
        const id = e.target.value; if(!id) return;
        const obra = state.obras.find(o=>o.id===id);
        openObraModal({mode:'edit', obra});
      });
    }

    // === Init ====================================================================================
    function init(){
      const data = Storage.load();
      state.obras = data.obras; state.items = data.items;
      renderObrasSelect(); renderTable();
      // Mostrar/ocultar filtros subtipo según selección actual
      qs('#subtipoFilter').style.display = (state.filters.categoria==='herramienta') ? 'block' : 'none';
      qs('#subtipoGroup').style.display = 'none';
      addEventListeners();
    }
    init();
  </script>
</body>
</html>
